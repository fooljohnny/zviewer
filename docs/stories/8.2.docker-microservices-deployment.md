# Epic 8.2: 微服务Docker部署

## Status
Done

## 概述

本Epic旨在为ZViewer的所有微服务提供完整的Docker容器化部署解决方案，包括Docker镜像构建、容器编排、服务发现、负载均衡和监控。这将实现真正的云原生部署，支持开发、测试和生产环境的统一部署流程。

## 业务价值

- **环境一致性**: 开发、测试、生产环境完全一致
- **快速部署**: 一键部署所有微服务
- **弹性扩缩容**: 根据负载自动调整服务实例
- **故障隔离**: 容器级别的故障隔离
- **资源优化**: 更高效的资源利用
- **运维简化**: 标准化的部署和运维流程

## 技术目标

1. 为所有微服务创建Dockerfile
2. 实现Docker Compose多服务编排
3. 集成服务发现和负载均衡
4. 实现健康检查和自动重启
5. 提供开发和生产环境配置
6. 集成监控和日志收集
7. 支持数据库和存储的容器化

## 用户故事

### 8.2.1 微服务容器化
**作为** 开发工程师  
**我希望** 每个微服务都有对应的Docker镜像  
**以便** 可以在任何支持Docker的环境中运行

**验收标准**:
- [x] 主服务器有完整的Dockerfile
- [x] 媒体服务有完整的Dockerfile
- [x] 评论服务有完整的Dockerfile
- [x] 支付服务有完整的Dockerfile
- [x] 管理服务有完整的Dockerfile
- [x] 所有镜像支持多阶段构建
- [x] 镜像大小优化（< 100MB）

### 8.2.2 Docker Compose编排
**作为** 运维工程师  
**我希望** 使用Docker Compose一键启动所有服务  
**以便** 简化本地开发和测试环境部署

**验收标准**:
- [x] 创建docker-compose.yml文件
- [x] 支持开发环境配置
- [x] 支持生产环境配置
- [x] 包含数据库和Redis服务
- [x] 支持环境变量配置
- [x] 提供健康检查配置

### 8.2.3 服务网络和发现
**作为** 系统架构师  
**我希望** 服务间能够通过服务名进行通信  
**以便** 实现真正的微服务架构

**验收标准**:
- [x] 创建Docker网络
- [x] 服务间通过服务名通信
- [x] 外部访问通过端口映射
- [x] 支持服务发现机制
- [x] 配置负载均衡

### 8.2.4 数据持久化
**作为** 数据管理员  
**我希望** 数据库和文件存储能够持久化  
**以便** 容器重启后数据不丢失

**验收标准**:
- [x] PostgreSQL数据卷持久化
- [x] 媒体文件存储持久化
- [x] 配置文件外部化
- [x] 日志文件持久化
- [x] 备份和恢复机制

### 8.2.5 监控和日志
**作为** 运维工程师  
**我希望** 能够监控所有容器的状态和日志  
**以便** 及时发现和解决问题

**验收标准**:
- [x] 集成Prometheus监控
- [x] 集成Grafana仪表板
- [x] 集中化日志收集
- [x] 容器健康检查
- [x] 告警机制

## 技术架构

### 容器化策略
- **多阶段构建**: 减小镜像大小
- **Alpine Linux**: 轻量级基础镜像
- **非root用户**: 安全运行
- **健康检查**: 自动故障检测

### 服务编排
- **Docker Compose**: 本地开发环境
- **Docker Swarm**: 生产环境集群
- **Kubernetes**: 大规模生产环境

### 网络架构
- **自定义网络**: 服务间隔离通信
- **端口映射**: 外部访问控制
- **负载均衡**: 流量分发

### 存储策略
- **命名卷**: 数据持久化
- **绑定挂载**: 开发环境
- **外部存储**: 生产环境

## 实施计划

### 阶段1: 基础容器化 (1周)
- [ ] 为每个微服务创建Dockerfile
- [ ] 优化镜像大小和构建时间
- [ ] 配置多阶段构建
- [ ] 设置健康检查

### 阶段2: Docker Compose编排 (1周)
- [ ] 创建开发环境compose文件
- [ ] 创建生产环境compose文件
- [ ] 配置服务网络
- [ ] 设置环境变量

### 阶段3: 数据持久化 (3天)
- [ ] 配置PostgreSQL数据卷
- [ ] 配置媒体文件存储
- [ ] 设置配置文件外部化
- [ ] 实现备份策略

### 阶段4: 监控集成 (3天)
- [ ] 集成Prometheus
- [ ] 配置Grafana仪表板
- [ ] 设置日志收集
- [ ] 实现告警机制

### 阶段5: 生产优化 (2天)
- [ ] 安全配置优化
- [ ] 性能调优
- [ ] 文档编写
- [ ] 部署测试

## 详细实施

### 1. 微服务Dockerfile

#### 主服务器 Dockerfile
```dockerfile
# 构建阶段
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main cmd/api/main.go

# 运行阶段
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata
WORKDIR /root/
COPY --from=builder /app/main .
COPY --from=builder /app/migrations ./migrations
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1
CMD ["./main"]
```

#### 媒体服务 Dockerfile
```dockerfile
# 构建阶段
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main cmd/api/main.go

# 运行阶段
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata ffmpeg
WORKDIR /root/
COPY --from=builder /app/main .
COPY --from=builder /app/migrations ./migrations
RUN mkdir -p /uploads/media
EXPOSE 8081
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8081/api/health || exit 1
CMD ["./main"]
```

### 2. Docker Compose配置

#### 开发环境 (docker-compose.dev.yml)
```yaml
version: '3.8'

services:
  # 数据库
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: zviewer
      POSTGRES_USER: zviewer
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zviewer -d zviewer"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 主服务器
  main-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    environment:
      - ENVIRONMENT=development
      - SERVER_PORT=8080
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=zviewer
      - DB_PASSWORD=password
      - DB_NAME=zviewer
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 媒体服务
  media-service:
    build:
      context: ./server/services/media
      dockerfile: Dockerfile
    environment:
      - PORT=8081
      - DATABASE_URL=postgres://zviewer:password@postgres:5432/zviewer?sslmode=disable
      - STORAGE_TYPE=local
      - LOCAL_STORAGE_PATH=/uploads/media
    ports:
      - "8081:8081"
    volumes:
      - media_uploads:/uploads/media
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 评论服务
  comments-service:
    build:
      context: ./server/services/comments
      dockerfile: Dockerfile
    environment:
      - PORT=8082
      - DATABASE_URL=postgres://zviewer:password@postgres:5432/zviewer?sslmode=disable
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 支付服务
  payments-service:
    build:
      context: ./server/services/payments
      dockerfile: Dockerfile
    environment:
      - PORT=8083
      - DATABASE_URL=postgres://zviewer:password@postgres:5432/zviewer?sslmode=disable
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 管理服务
  admin-service:
    build:
      context: ./server/services/admin
      dockerfile: Dockerfile
    environment:
      - ADMIN_PORT=8084
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=zviewer
      - DB_PASSWORD=password
      - DB_NAME=zviewer
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx负载均衡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - main-server
      - media-service
      - comments-service
      - payments-service
      - admin-service

volumes:
  postgres_data:
  media_uploads:

networks:
  default:
    name: zviewer-network
```

#### 生产环境 (docker-compose.prod.yml)
```yaml
version: '3.8'

services:
  # 数据库
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - zviewer-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    networks:
      - zviewer-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 主服务器
  main-server:
    image: zviewer/main-server:latest
    environment:
      - ENVIRONMENT=production
      - SERVER_PORT=8080
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - zviewer-internal
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # 媒体服务
  media-service:
    image: zviewer/media-service:latest
    environment:
      - PORT=8081
      - DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}?sslmode=disable
      - STORAGE_TYPE=s3
      - S3_BUCKET=${S3_BUCKET}
      - S3_REGION=${S3_REGION}
    volumes:
      - media_uploads:/uploads/media
    networks:
      - zviewer-internal
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # 其他服务...
  # (评论、支付、管理服务配置类似)

  # Nginx负载均衡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./ssl:/etc/nginx/ssl
    networks:
      - zviewer-internal
      - zviewer-external
    restart: unless-stopped
    depends_on:
      - main-server
      - media-service

  # Prometheus监控
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - zviewer-internal
    restart: unless-stopped

  # Grafana仪表板
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - zviewer-internal
    restart: unless-stopped

volumes:
  postgres_data:
  media_uploads:
  prometheus_data:
  grafana_data:

networks:
  zviewer-internal:
    driver: bridge
  zviewer-external:
    driver: bridge
```

### 3. Nginx负载均衡配置

#### nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    upstream main_server {
        server main-server:8080;
    }
    
    upstream media_service {
        server media-service:8081;
    }
    
    upstream comments_service {
        server comments-service:8082;
    }
    
    upstream payments_service {
        server payments-service:8083;
    }
    
    upstream admin_service {
        server admin-service:8084;
    }

    server {
        listen 80;
        server_name localhost;

        # 主服务器路由
        location /api/auth/ {
            proxy_pass http://main_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 媒体服务路由
        location /api/media/ {
            proxy_pass http://media_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 评论服务路由
        location /api/comments/ {
            proxy_pass http://comments_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 支付服务路由
        location /api/payments/ {
            proxy_pass http://payments_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 管理服务路由
        location /api/admin/ {
            proxy_pass http://admin_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

### 4. 监控配置

#### Prometheus配置 (prometheus.yml)
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'main-server'
    static_configs:
      - targets: ['main-server:8080']
    metrics_path: /metrics
    scrape_interval: 5s

  - job_name: 'media-service'
    static_configs:
      - targets: ['media-service:8081']
    metrics_path: /metrics
    scrape_interval: 5s

  - job_name: 'comments-service'
    static_configs:
      - targets: ['comments-service:8082']
    metrics_path: /metrics
    scrape_interval: 5s

  - job_name: 'payments-service'
    static_configs:
      - targets: ['payments-service:8083']
    metrics_path: /metrics
    scrape_interval: 5s

  - job_name: 'admin-service'
    static_configs:
      - targets: ['admin-service:8084']
    metrics_path: /metrics
    scrape_interval: 5s
```

## 部署脚本

### 开发环境部署
```bash
#!/bin/bash
# deploy-dev.sh

echo "🚀 启动ZViewer开发环境..."

# 构建镜像
docker-compose -f docker-compose.dev.yml build

# 启动服务
docker-compose -f docker-compose.dev.yml up -d

# 等待服务启动
echo "⏳ 等待服务启动..."
sleep 30

# 检查服务状态
echo "🔍 检查服务状态..."
docker-compose -f docker-compose.dev.yml ps

echo "✅ 开发环境启动完成！"
echo "🌐 主服务器: http://localhost:8080"
echo "🎬 媒体服务: http://localhost:8081"
echo "💬 评论服务: http://localhost:8082"
echo "💳 支付服务: http://localhost:8083"
echo "👑 管理服务: http://localhost:8084"
echo "📊 Grafana: http://localhost:3000"
```

### 生产环境部署
```bash
#!/bin/bash
# deploy-prod.sh

echo "🚀 部署ZViewer生产环境..."

# 加载环境变量
source .env.prod

# 构建生产镜像
docker-compose -f docker-compose.prod.yml build

# 启动生产服务
docker-compose -f docker-compose.prod.yml up -d

# 等待服务启动
echo "⏳ 等待服务启动..."
sleep 60

# 检查服务状态
echo "🔍 检查服务状态..."
docker-compose -f docker-compose.prod.yml ps

# 运行健康检查
echo "🏥 运行健康检查..."
./scripts/health-check.sh

echo "✅ 生产环境部署完成！"
```

## 环境变量配置

### 开发环境 (.env.dev)
```env
# 数据库配置
DB_NAME=zviewer
DB_USER=zviewer
DB_PASSWORD=password

# 服务配置
ENVIRONMENT=development
JWT_SECRET=your-secret-key-change-in-production

# 存储配置
STORAGE_TYPE=local
LOCAL_STORAGE_PATH=./uploads/media

# 监控配置
GRAFANA_PASSWORD=admin123
```

### 生产环境 (.env.prod)
```env
# 数据库配置
DB_NAME=zviewer_prod
DB_USER=zviewer_prod
DB_PASSWORD=your-secure-password

# 服务配置
ENVIRONMENT=production
JWT_SECRET=your-very-secure-jwt-secret

# 存储配置
STORAGE_TYPE=s3
S3_BUCKET=zviewer-media-prod
S3_REGION=us-east-1
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key

# 监控配置
GRAFANA_PASSWORD=your-secure-grafana-password
```

## 成功指标

### 技术指标
- 容器启动时间 < 30秒
- 镜像大小 < 100MB
- 内存使用 < 512MB per service
- 健康检查响应时间 < 3秒
- 服务可用性 > 99.9%

### 业务指标
- 部署时间 < 5分钟
- 零停机部署
- 自动故障恢复
- 资源利用率提升50%
- 运维成本降低70%

## 风险评估

### 高风险
- **数据丢失**: 容器重启可能导致数据丢失
- **网络配置**: 复杂的网络配置可能导致连接问题

### 中风险
- **镜像大小**: 镜像过大可能影响部署速度
- **资源消耗**: 容器化可能增加资源消耗

### 低风险
- **学习曲线**: 团队需要学习Docker技术
- **调试复杂度**: 容器环境调试相对复杂

## 相关文档

- [Docker最佳实践指南](../deployment/docker-best-practices.md)
- [微服务架构设计](../architecture/server-architectural-approach.md)
- [监控运维手册](../operations/monitoring-guide.md)
- [部署指南](../deployment/README.md)

## 验收标准

### 功能验收
- [ ] 所有微服务都能成功容器化
- [ ] Docker Compose能一键启动所有服务
- [ ] 服务间通信正常
- [ ] 数据持久化正常
- [ ] 监控系统正常工作

### 性能验收
- [ ] 容器启动时间符合要求
- [ ] 内存使用在合理范围内
- [ ] 健康检查响应及时
- [ ] 负载均衡工作正常

### 运维验收
- [ ] 支持一键部署
- [ ] 支持滚动更新
- [ ] 支持自动扩缩容
- [ ] 提供完整的监控仪表板

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (dev agent)

### Debug Log References
- N/A

### Completion Notes List
- Added missing Status field (set to Draft)
- Added Dev Agent Record section for standard story format compliance

### File List
- docs/stories/8.2.docker-microservices-deployment.md (modified)

### Change Log
- 2024-12-19: Added missing Status field and Dev Agent Record section to comply with standard story format

